#!/usr/bin/env bash
set -euo pipefail

# --- 0. 說明函式 (Usage Function) ---
show_help() {
  cat << EOF
vcmake - A transparent wrapper for CMake with automatic vcpkg integration.

This script behaves exactly like 'cmake', passing all arguments directly to it,
while automatically injecting arguments for vcpkg integration.

USAGE:
  vcmake [cmake-options] <path-to-source | path-to-build>

BEHAVIOR:
  1. Injects the vcpkg toolchain file automatically.
     (-DCMAKE_TOOLCHAIN_FILE=\$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake)
  2. Injects the target triplet if the VCPKG_DEFAULT_TRIPLET environment
     variable is set and not overridden in the command line.
     (-DVCPKG_TARGET_TRIPLET=\$VCPKG_DEFAULT_TRIPLET)
  3. Injects other useful defaults like '-DCMAKE_EXPORT_COMPILE_COMMANDS=ON'
     and ccache launcher if available.

ENVIRONMENT VARIABLES:
  VCPKG_ROOT              - Path to your vcpkg installation.
                            (Fallback: \$HOME/vcpkg)
  VCPKG_DEFAULT_TRIPLET   - Default target triplet to use (e.g., x64-osx, x64-linux).

EXAMPLES:
  # Configure a project (toolchain and triplet are handled automatically)
  vcmake -S . -B build -G Ninja

  # Build the project (works for all cmake commands)
  vcmake --build build -j

  # Override the default triplet for a specific build
  vcmake -S . -B build_win -DVCPKG_TARGET_TRIPLET=x64-windows
EOF
}

# --- 處理 help 參數或無參數的情況 ---
# 如果參數是 -h/--help，或者沒有任何參數，就顯示說明
if [[ "${1:-}" == "-h" ]] || [[ "${1:-}" == "--help" ]] || [ $# -eq 0 ]; then
  show_help
  exit 0
fi


# --- 1. 尋找 VCPKG_ROOT ---
# 優先使用環境變數 VCPKG_ROOT，若未設定則尋找 $HOME/vcpkg
if [ -z "${VCPKG_ROOT:-}" ]; then
  if [ -d "$HOME/vcpkg" ]; then
    VCPKG_ROOT="$HOME/vcpkg"
  else
    echo "[vcmake ERROR] VCPKG_ROOT not set and fallback directory '$HOME/vcpkg' not found." >&2
    echo "               Please set the VCPKG_ROOT environment variable." >&2
    exit 1
  fi
fi

TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
if [ ! -f "$TOOLCHAIN_FILE" ]; then
  echo "[vcmake ERROR] vcpkg toolchain file not found at: $TOOLCHAIN_FILE" >&2
  exit 1
fi

# --- 2. 準備要自動注入的參數 ---
vcpkg_args=()

# 固定注入工具鏈檔案參數
vcpkg_args+=("-DCMAKE_TOOLCHAIN_FILE=$TOOLCHAIN_FILE")

# --- 3. 智慧處理 VCPKG_TARGET_TRIPLET ---
# 檢查用戶是否已經手動在參數中指定了 triplet
has_triplet=0
for arg in "$@"; do
  if [[ "$arg" == -DVCPKG_TARGET_TRIPLET=* ]]; then
    has_triplet=1
    break
  fi
done

# 如果用戶沒有手動指定，則嘗試使用 VCPKG_DEFAULT_TRIPLET 環境變數
if [ $has_triplet -eq 0 ] && [ -n "${VCPKG_DEFAULT_TRIPLET:-}" ]; then
  echo "[vcmake] Using triplet from VCPKG_DEFAULT_TRIPLET: '${VCPKG_DEFAULT_TRIPLET}'"
  vcpkg_args+=("-DVCPKG_TARGET_TRIPLET=${VCPKG_DEFAULT_TRIPLET}")
fi

# --- 4. (可選) 注入其他實用參數 ---
# 自動啟用 compile_commands.json 的生成，方便 IDE 使用
has_export_commands=0
for arg in "$@"; do
  if [[ "$arg" == -DCMAKE_EXPORT_COMPILE_COMMANDS=* ]]; then
    has_export_commands=1
    break
  fi
done
if [ $has_export_commands -eq 0 ]; then
    vcpkg_args+=("-DCMAKE_EXPORT_COMPILE_COMMANDS=ON")
fi

# 如果 ccache 存在，自動啟用
if command -v ccache >/dev/null 2>&1; then
  vcpkg_args+=("-DCMAKE_C_COMPILER_LAUNCHER=ccache" "-DCMAKE_CXX_COMPILER_LAUNCHER=ccache")
fi

# --- 5. 執行真正的 cmake ---
# 使用 exec 可讓 cmake 程序取代目前的 shell，更有效率
echo "[vcmake] Injecting vcpkg arguments and executing cmake..."
exec cmake "${vcpkg_args[@]}" "$@"