#!/usr/bin/env bash
set -euo pipefail

# --- 設定 (Configuration) ---
VENV_DIR=".venv" # 虛擬環境目錄名稱
PYTHON_CMD="python3" # 使用 python3 避免與舊版 python2 混淆

# --- 顏色與訊息函式 (Colors & Logging) ---
# 為輸出加上顏色，增加可讀性
COLOR_GREEN='\033[0;32m'
COLOR_YELLOW='\033[0;33m'
COLOR_RED='\033[0;31m'
COLOR_RESET='\033[0m'

# msg "訊息"：顯示一般資訊
msg() {
  echo -e "${COLOR_GREEN}pyrun:${COLOR_RESET} $1"
}

# warn "訊息"：顯示警告
warn() {
  echo -e "${COLOR_YELLOW}pyrun:${COLOR_RESET} $1"
}

# die "訊息"：顯示錯誤並結束程式
die() {
  echo -e "${COLOR_RED}pyrun: ERROR:${COLOR_RESET} $1" >&2
  exit 1
}

# --- 功能：清理虛擬環境 (Clean command) ---
if [[ "${1:-}" == "--clean" ]]; then
  if [ -d "$VENV_DIR" ]; then
    msg "Cleaning up virtual environment at '$VENV_DIR'..."
    rm -rf "$VENV_DIR"
    msg "Cleanup complete."
  else
    warn "No virtual environment found at '$VENV_DIR'."
  fi
  exit 0
fi

# --- 功能：顯示幫助 (Help & Usage) ---
if [[ "${1:-}" == "" ]] || [[ "${1:-}" == "-h" ]] || [[ "${1:-}" == "--help" ]]; then
  echo "Usage: pyrun <script.py | -c 'code'> [args...]"
  echo "       pyrun --clean"
  echo ""
  echo "A smart Python script runner that auto-manages a virtual environment."
  echo ""
  echo "Commands:"
  echo "  <script.py> [args...]    Run a Python script."
  echo "  -c 'code' [args...]      Run a string of Python code."
  echo "  --clean                  Remove the virtual environment directory ($VENV_DIR)."
  exit 0
fi

# --- 功能：執行程式碼字串 (Code string execution) ---
IS_CMD=0
if [[ "${1}" == "-c" ]]; then
  IS_CMD=1
  CMD_STR="${2:-}"
  [ -n "$CMD_STR" ] || die "A code string must be provided after -c."
  shift 2 # 將 '-c' 和 'code' 移出參數列表
  ARGS=("$@")
else
  SCRIPT="${1:-}"
  [ -f "$SCRIPT" ] || die "Script file not found: '$SCRIPT'"
  shift 1 # 將 script.py 移出參數列表
  ARGS=("$@")
fi

# --- 核心邏輯：環境與依賴管理 (Core Logic) ---

# 1. 自動偵測依賴文件
DEP_FILE=""
if [ -f "pyproject.toml" ]; then
  DEP_FILE="pyproject.toml"
elif [ -f "requirements.txt" ]; then
  DEP_FILE="requirements.txt"
fi

# 2. 判斷是否需要安裝/更新依賴 (智慧快取)
# 條件：虛擬環境不存在，或依賴文件比虛擬環境還新
NEEDS_INSTALL=0
if [ -n "$DEP_FILE" ]; then
  if [ ! -d "$VENV_DIR" ] || [ "$DEP_FILE" -nt "$VENV_DIR" ]; then
    NEEDS_INSTALL=1
  fi
elif [ ! -d "$VENV_DIR" ]; then
    # 即使沒有依賴文件，若 venv 不存在也需要建立
    NEEDS_INSTALL=1
fi

# 3. 執行安裝 (如果需要)
if [ "$NEEDS_INSTALL" -eq 1 ]; then
  # 優先使用 uv (因为它更快)，若無則使用內建的 venv
  if command -v uv >/dev/null 2>&1; then
    msg "Setting up venv with uv..."
    uv venv -p "$PYTHON_CMD" "$VENV_DIR" >/dev/null
    . "$VENV_DIR/bin/activate"
    if [ -n "$DEP_FILE" ]; then
      msg "Installing dependencies from '$DEP_FILE' with uv..."
      # uv 可自動處理 pyproject.toml 和 requirements.txt
      uv pip install -r "$DEP_FILE" 2>/dev/null || uv pip install .
    fi
  else
    msg "Setting up venv with python -m venv..."
    "$PYTHON_CMD" -m venv "$VENV_DIR"
    . "$VENV_DIR/bin/activate"
    "$PYTHON_CMD" -m pip install -U pip >/dev/null
    if [ -n "$DEP_FILE" ]; then
      msg "Installing dependencies from '$DEP_FILE' with pip..."
      if [[ "$DEP_FILE" == "pyproject.toml" ]]; then
        pip install .
      else
        pip install -r "$DEP_FILE"
      fi
    fi
  fi
  # 更新 .venv 目錄的時間戳，作為快取標記
  touch "$VENV_DIR"
  msg "Environment is ready."
else
  if [ -n "$DEP_FILE" ]; then
    msg "Dependencies are up-to-date. Activating venv..."
  else
    msg "Activating venv..."
  fi
  . "$VENV_DIR/bin/activate"
fi

# --- 執行 Python 腳本 (Execution) ---
msg "Running script..."
echo "--------------------"

if [ "$IS_CMD" -eq 1 ]; then
  exec "$PYTHON_CMD" -c "$CMD_STR" "${ARGS[@]}"
else
  exec "$PYTHON_CMD" "$SCRIPT" "${ARGS[@]}"
fi