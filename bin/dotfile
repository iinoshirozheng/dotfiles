#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
dotfiles helper

Usage:
  dotfile link            # stow 主要套件
  dotfile unlink          # 移除 symlink
  dotfile restow          # 重新套用
  dotfile update          # git pull + restow
USAGE
}

root="${HOME}/dotfiles"

cmd="${1:-help}"
case "$cmd" in
  link)
    (cd "$root/stow" && stow -t "$HOME" --restow zsh starship git eza nvim)
    ;;
  unlink)
    (cd "$root/stow" && stow -t "$HOME" -D zsh starship git eza nvim)
    ;;
  restow)
    (cd "$root/stow" && stow -t "$HOME" --restow zsh starship git eza nvim)
    ;;
  update)
    echo "Updating dotfiles..."
    cd "$root"
    if ! git diff-index --quiet HEAD --; then
      echo "Stashing changes..."
      git stash
      STASHED=1
    fi
    git pull --rebase
    if [ "${STASHED:-0}" -eq 1 ]; then
      echo "Restoring changes..."
      git stash pop
    fi
    (cd "$root/stow" && stow -t "$HOME" --restow zsh starship git eza nvim)
    echo "Update complete!"
    ;;
  *)
    usage ;;
esac
